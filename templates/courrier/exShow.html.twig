{# page d'affichage du contenu du fichier excel#}
{% extends 'base.html.twig' %}
{% block title %}Pieces{% endblock %}
{% block navbar %}
    <header>

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="{{ path('page_index', {id: user.id}) }}"><h2>ACCUEIL</h2></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <li class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        {#<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>#}
                    </li>
                </ul>
            </li>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a  class="nav-link" href="#" id="receivedDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <img src="{{ asset('assets/svg/envelope.svg') }}" style="height:30px;">
                        {# Debut de la gestion de la notification#}
                        {% set i = 0 %}
                        {% for liste in listeCourrier %}
                            {% if liste.recipient.id == user.id %}
                                {% if liste.isRead == 0  %}
                                    {% set i = i + 1 %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {% if i == 0 %}
                            <span class="badge rounded-pill badge-notification bg-danger badge badge-danger badge-counter d-none ">  {{ i }}</span>
                        {% else %}
                            <span class="badge rounded-pill badge-notification bg-danger badge badge-danger badge-counter "> </span>
                        {% endif %}
                        {# fin #}
                    </a>

                    <div class="dropdown-menu dropdown-menu-right drop" aria-labelledby="receivedDropdown">
                        <h6 class="dropdown-header text-center" >CENTRE COURRIER</h6>
                        {% if app.user.received|length == 0 %}
                            <p class="text-center"> Aucun courrier reçus </p>
                        {% else %}
                            {% for liste in listeCourrier %}
                                {% if liste.recipient.id == user.id %}
                                    {% set bold = "" %}
                                    {% if liste.isRead == 0  %}
                                        {% set bold ="font-weight-bold" %}
                                    {% endif %}
                                    <a href="{{ path("excel", {id: liste.id}) }}" class="d-flex hope {{bold}}" style="height:5.3rem;">
                                        <div class ="jo">
                                            <img class="rounded-circle" src="{{ asset('assets/svg/abstract-user.svg') }}">
                                        </div>
                                        <div style="display:block;">
                                            <div class="text " style="color:black;">
                                                {{ liste.nomC }}
                                            </div>
                                            <div style="color:#b7b9cc;" class="text-truncate">
                                                {{ liste.sender.nom}} , {{ liste.status}}
                                            </div>
                                        </div>
                                    </a>
                                {% endif %}
                            {% endfor %}

                        {% endif %}


                        <a class="dropdown-item text-center" href="{{ path('received') }}">Voir tous les courriers</a>
                    </div>

                    </a>
                </li>
            </ul>

            {# acces de la liste uniquement au utilisateur ayant le role admin #}
            <ul class="navbar-nav">
                <li class="nav-item">
                    {% if is_granted('ROLE_ADMIN') %}
                        <a class="nav-link" href="{{ path('user_index') }}">Liste d'utilisateur</a>
                    {% endif %}
                </li>
            </ul>
            {#fin#}

            <ul class="navbar-nav">
                <div class="dropdown">
                    <li class="nav-item">
                        <img src ="{{asset('assets/svg/4.png')}}" class="img-profile rounded-circle dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                            <span class="dropdown-item"></span>
                            <div class="d-flex">
                                <img src ="{{asset('assets/svg/ip-address.svg')}}" style="height:25px;width:25px;">
                                <h5 style="margin-left:4px;">  {{ user.IP }}</h5>
                            </div>
                            <div  class="d-flex text-center" style="margin-top:5px;">
                                <img src ="{{asset('assets/svg/profile_icon.png')}}" style="height:25px;width:25px;">
                                <h5 style="margin-left:4px;">  {{ user.Nom }}</h5>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="d-flex">
                                <img src ="{{asset('assets/svg/logout.svg')}}">
                                <a class="dropdown-item" style="padding-left:2px;" href="{{ path('app_logout') }}">Déconnexion</a>
                            </div>
                        </div>
                    </li>
                </div>
            </ul>

        </nav>
    </header>
{% endblock %}
{% block body %}
    <fieldset class="border" style="width:400px; height:auto; margin-left:30px;" >
        <legend class="w-auto font-weight-bold "><h3>Notes sur ce courrier</h3> </legend>

        {% set notes= courrier.notes|split('~')%}
        {% set lnotes = notes|length - 1 %}

        {% for note in notes %}
            <h6>- {{ note }}</h6>
        {% endfor %}


    </fieldset>
    {#-------------------- notes de retour------------------------#}

    <fieldset id="joker" class="" style="/*margin:0px;padding:0px;width:500px;height:200px;*/width:500px;position:absolute;right:12px;top:70px;margin-bottom:200px;margin-right:100px;" >
       <legend  class="w-auto">Notes d'erreur</legend>
        <input type="textarea" class="form-control" id="notes">
      <button class="btn btn-outline-warning waves-effect" onclick="renvoyer()"> Envoyer</button>
    </fieldset>

    {#-------------------- fin notes de retour------------------------#}

    <div class="row text-center" style="margin-top: 70px;">
        <div class="col-12 justify-content-center">
            <div class="card card-trap"><div class="card-header">  <h1>Pieces</h1></div>
                <div class="card-body">
                    <table class="table table-striped table-bordered table_data">
                        <thead>
                        <tr>

                            <th class="text-center" >N° cmd</th>
                            <th class="text-center" > N° récept </th>
                            <th class="text-center" >N°BL</th>
                            <th class="text-center">Fournisseur</th>
                            <th class="text-center">Rayon</th>
                            <th class="text-center">D.réception</th>
                            <th class="text-center">Montant HT</th>
                            <th class="text-center d-none" >v.envoyeur</th>
                            <th class="text-center">Valide</th>
                        </tr>
                        </thead>
                        <tbody>
                            {% set nbre_pieces = pieces|length %}
                            {% set nbre_pieces_check = 0 %}
                            {% for piece in pieces %}
                                <tr>
                                    <td>{{ piece.nCMD}} </td>
                                    <td>{{ piece.nRecept}} </td>
                                    <td> {{ piece.nBL}} </td>
                                    <td>{{ piece.fournisseur }}</td>
                                    <td> {{ piece.rayon }} </td>
                                    <td> {{ piece.DReception }} </td>
                                    <td> {{ piece.montantHT }} </td>
                                   <td class="d-none">
                                       {#affichage de la validation de l'envoyeur #}
                                    {% set checked = piece.secondValide != 0 ? 'checked' : ''  %}
                                    <input type="checkbox" {{ checked }} class="form-control "  disabled  >
                                   </td>

                                    {% set isChecked = piece.valideRecipient != 0 ? 'checked' : ''  %}
                                    {% set isDisabled = piece.isDisabled != 0 ? 'disabled' : ''  %}
                                    <td> <input type="checkbox" {{ isChecked }} class="form-control boxcheck" data-id="{{ piece.id }}" onchange="setValidate({{ piece.id }})" {{ isDisabled }}>
                                     {% if piece.valideRecipient == 1 %}
                                            {% set nbre_pieces_check = nbre_pieces_check + 1 %}
                                        {% endif %}
                                    </td>
                                </tr>

                            {% endfor %}
                        </tbody>
                    </table>
                    {% set valid = (nbre_pieces == nbre_pieces_check)   ? '' : 'd-none'  %}
                    {% set dis = courrier.valider == 1 ? 'd-none' : ' ' %}

                    <a href="{{path('received')}}" class="btn btn-success {{ valid }} {{ dis }}"  id="btn-validate" onclick="confirm()" {{ dis }}> validation</a>
                </div>
            </div>
        </div>
    </div>


    <script>
        var nbPiece = {{ nbre_pieces }};
        var nbChecked = {{ nbre_pieces_check }};

        function renvoyer()
        {
            var erreur = document.getElementById("notes").value;
            console.log(document.getElementById("notes").value);
            $.ajax({
                url : '{{ path('excel',{id: courrier.id}) }}' ,
                method : 'POST',
                data : {errnotes : erreur },
                success: function(){
                    bootbox.alert('envoye du rapport d\'erreur effectuée');
                    window.location.replace("{{path('send')}}");

                }
            })

        }
        // ajax modification de la valeur de la colone validate
        function setValidate(id){
            $.ajax({
                url : '{{ path('ajax_validate_courier') }}' ,
                method : 'POST',
                data : {id : id },// @ToDo recuperer id
                success : function (data) {
                    if(data){
                        nbChecked++;
                    } else {
                        nbChecked--;
                    }
                    if (nbChecked == nbPiece)
                    {
                        $('#btn-validate').removeClass('d-none')
                    } else
                    {
                        $('#btn-validate').addClass('d-none')
                    }
                    }
                });
            }
            //rendre disabled les checkbox
        function setDisabled(arrayIds)
        {
            $.ajax({
                url : '{{ path('ajax_disabled_courier') }}' ,
                method : 'POST',
                data : {ids : arrayIds },// @ToDo recuperer id
                success : function (data)
                {

                    $('.boxcheck').attr("disabled","disabled");
                    $('.btn-validate').attr("disabled","disabled");
                    //debut reception php->twg
                    //var response = JSON.parse(data);
                    // console.log($response);
                    // fin

                }
            });
        }
        function confirm()
            {
                var checkboxes = $('.boxcheck');
                var arrayIds = [];
                //parcour avec each
                $.each(checkboxes , function (index,value) {
                    arrayIds.push($(this).data('id'))
                });
                console.log(arrayIds);
                setDisabled(arrayIds);
                //alert(disabled);
            }
    </script>
{% endblock %}
