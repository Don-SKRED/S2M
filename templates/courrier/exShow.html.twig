{% extends 'base.html.twig' %}

{% block title %}Section Courrier{% endblock %}
 {% block navbar %}
     <header>
         <nav class="navbar navbar-expand-lg navbar-light bg-light">
             <a class="navbar-brand" href="{{ path('page_index', {id: user.id}) }}"><h2>ACCUEIL</h2></a>
             <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                 <span class="navbar-toggler-icon"></span>
             </button>

             <li class="collapse navbar-collapse" id="navbarSupportedContent">
                 <ul class="navbar-nav mr-auto">
                     <li class="nav-item active">
                         {#<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>#}
                     </li>
                     {#  <li class="nav-item">
                           <a class="nav-link" href="#">Link</a>
                       </li>#}
                     {#      <li class="nav-item dropdown">
                             <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                 Courrier
                             </a>
                             {#  <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                               <a class="dropdown-item" href="{{ path("received") }}">Boites de receptions</a>
                               <a class="dropdown-item" href="{{ path("send") }}">Courrier envoyés</a>
                               {#<div class="dropdown-divider"></div>
                               <a class="dropdown-item" href="#">Something else here</a>
                           </div>#}
                     </li>

                 </ul>
                 <ul class="navbar-nav">
                     <li class="nav-item dropdown">
                         <a  class="nav-link" href="#" id="receivedDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                             <img src="{{ asset('assets/svg/envelope.svg') }}" style="height:30px;">
                                 {# Debut de la gestion de la notification#}
                                 {% set i = 0 %}
                                 {% for liste in listeCourrier %}
                                     {% if liste.recipient.id == user.id %}
                                         {% if liste.isRead == 0  %}
                                             {% set i = i + 1 %}
                                         {% endif %}
                                     {% endif %}
                                 {% endfor %}
                                 {% if i == 0 %}
                                     <span class="badge rounded-pill badge-notification bg-danger badge badge-danger badge-counter d-none ">  {{ i }}</span>
                                 {% else %}
                                     <span class="badge rounded-pill badge-notification bg-danger badge badge-danger badge-counter ">  {{ i }}</span>
                                 {% endif %}
                                 {# fin #}
                         </a>
                         <div class="dropdown-menu dropdown-menu-right drop" aria-labelledby="receivedDropdown">

                             <h6 class="dropdown-header text-center" >CENTRE COURRIER</h6>
                             {% if app.user.received|length == 0 %}
                                 <p class="text-center"> Aucun courrier reçus </p>

                             {% else %}
                                {% for liste in listeCourrier %}
                                        {% if liste.recipient.id == user.id %}
                                                {% set bold = "" %}
                                                {% if liste.isRead == 0 %}
                                                    {% set bold ="font-weight-bold" %}
                                                {% endif %}
                                            <a href="{{ path("excel", {id: liste.id}) }}" class="d-flex hope {{bold}}" style="height:5.3rem;">
                                                <div class ="jo">
                                                    <img class="rounded-circle" src="{{ asset('assets/svg/abstract-user.svg') }}">
                                                </div>
                                                <div style="display:block;">
                                                    <div class="text " style="color:black;">
                                                        {{ liste.nomC }}
                                                    </div>
                                                    <div style="color:#b7b9cc;" class="text-truncate">
                                                        {{ liste.sender.nom}} , {{ liste.status}}
                                                    </div>

                                                </div>
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                             {% endif %}


                             {# <div class="dropdown-divider"></div> #}
                             <a class="dropdown-item text-center" href="{{ path('received') }}">Voir tous les courriers</a>
                         </div>

                         </a>
                     </li>
                 </ul>
                 <ul class="navbar-nav">
                     <li class="nav-item">
                         {% if is_granted('ROLE_ADMIN') %}
                             <a class="nav-link" href="{{ path('user_index') }}">Liste d'utilisateur</a>


                         {% endif %}

                     </li>
                 </ul>
                 <ul class="navbar-nav">

                     <div class="dropdown">
                         <li class="nav-item">
                             {# <span class="mr-2 d-none d-flex text-gray-600 small"> {{ user.Nom }}</span> #}
                             <img src ="{{asset('assets/svg/4.png')}}" class="img-profile rounded-circle dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                             <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                 <p class="dropdown-item">
                                 <h2>IP:</h2><p>{{ user.IP }}</p>
                                 <h2>Nom:</h2><p>{{ user.Nom }}</p></p>

                                 <div class="dropdown-divider"></div>
                                 <a class="dropdown-item" href="{{ path('app_logout') }}">Déconnexion</a>
                             </div>
                         </li>
                     </div>
                 </ul>
                 </div>
             </li>
         </nav>
     </header>
 {% endblock %}
{% block body %}
    
    <h4 class="text-center"> Pieces</h4>
    <table style="margin: 50px;" class="table table-striped table-bordered table_data">
        <thead></thead>
        <tr>
            <th>Nom du courrier</th>
            <th>nom</th>
            <th>prenom</th>
            <th>numero</th>
            <th>Valide</th>
        </tr>
        <tbody>
               {% set nbre_pieces = upload|length %}
        {% set nbre_pieces_check = 0 %}
        {% for piece in upload %}
            <tr>
                <td>{{ piece.courier.nomC }} </td>
                <td>{{ piece.nom }}</td>
                <td> {{ piece.prenom }} </td>
                <td> {{ piece.numero }} </td>
                {% set isChecked = piece.valide != 0 ? 'checked' : ''  %}
                {% set isDisabled = piece.isDisabled != 0 ? 'disabled' : ''  %}
                <td> <input type="checkbox" {{ isChecked }} class="form-control boxcheck" data-id="{{ piece.id }}" onchange="setValidate({{ piece.id }})" {{ isDisabled }}>
                 {% if piece.valide == 1 %}
                        {% set nbre_pieces_check = nbre_pieces_check + 1 %}
                    {% endif %}
                </td>

            </tr>

        {% endfor %}

        </tbody>

    </table>
    {% set valid = (nbre_pieces == nbre_pieces_check) ? '' : 'd-none'  %}

    <button class="btn btn-success {{ valid }}"  id="btn-validate" onclick="confirm()"> validation</button>

    {#-------------------- notes de retour------------------------#}


  {{ form_start(form) }}
    <div>
      {{ form_label(form.notes) }}
      {{ form_widget(form.notes) }}
  </div>
    <div class="d-none">
      {{ form_label(form.nom_c) }}
      {{ form_widget(form.nom_c) }}
  </div>
    <div class="d-none">
      {{ form_label(form.status) }}
      {{ form_widget(form.status) }}
  </div>
    <div class="d-none">
      {{ form_label(form.recipient) }}
      {{ form_widget(form.recipient) }}
  </div>
    <div class="d-none">
      {{ form_label(form.fichier) }}
      {{ form_widget(form.fichier) }}
  </div>

    {{ form_widget(form.envoyer) }}
    {{ form_end(form) }}





    {#-------------------- fin notes de retour------------------------#}







    <script>

        //$('.boxcheck').removeAttr('disabled');
            var nbPiece = {{ nbre_pieces }}
            var nbChecked = {{ nbre_pieces_check }};
            // ajax modification de la valeur de la colone validate
            function setValidate(id){
                $.ajax({
                    url : '{{ path('ajax_validate_courier') }}' ,
                    method : 'POST',
                    data : {id : id },// @ToDo recuperer id
                    success : function (data) {
                        if(data){
                            nbChecked++;
                        } else {
                            nbChecked--;
                        }

                        if (nbChecked == nbPiece){
                            // display
                            $('#btn-validate').removeClass('d-none')

                        } else {
                            //display none
                            $('#btn-validate').addClass('d-none')
                        }

                    }

                });
            }

        function setDisabled(arrayIds){
            $.ajax({
                url : '{{ path('ajax_disabled_courier') }}' ,
                method : 'POST',
                data : {ids : arrayIds },// @ToDo recuperer id
                success : function (data) {
                    //debut reception php->twg
                    //var response = JSON.parse(data);
                   // console.log($response);
                    // fin
                    $('.boxcheck').attr("disabled","disabled");
                    $('.btn-validate').attr("disabled","disabled");

                }

            });
        }
            function confirm()
            {
                //$('.boxcheck').attr("disabled","disabled");
                var checkboxes = $('.boxcheck');
                var arrayIds = [];
                $.each(checkboxes , function (index,value) {
                    arrayIds.push($(this).data('id'))
                });

                console.log(arrayIds)
                setDisabled(arrayIds);
                //alert(disabled);
            }


    </script>













   {# ------------------------------------------------------------------------------------------
   {%  set dataHeader = data[0] %}
    {%  set count = 0 %}
    <table class="table table-striped table-bordered table_data">
    <thead>
    <tr>
        {% for header in dataHeader %}
        <th>{{header}}</th>
        {% endfor %}
    </tr>
    </thead>
        <tbody>
        {% for array in data %}
            {% if count > 0 %}
                <tr>
                {% for value in array %}
                    <td>{{ value }}</td>
                {% endfor %}
                </tr>
            {% endif %}

            {%  set count = count + 1 %}
        {% endfor %}
        </tbody>
    </table>*/#}

  {#  <script>
        $(document).ready(function () {
            $.ajax({
                url : '{{ path('ajax_excel') }}' ,
                method : 'POST',
                data : {id : 78},// @ToDo recuperer id
                success : function (data) {
                    alert ('reussit')
                    $('#excel_show').html(data);
                }

            });

        })
    </script>
   ------------------------------------------------------------------------------------------------------------- #}
{% endblock %}
