{% extends 'base.html.twig' %}
{% block title %}Pieces{% endblock %}
{% block navbar %}

    <header>

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="{{ path('page_index', {id: user.id}) }}"><h2>ACCUEIL</h2></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <li class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        {#<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>#}
                    </li>
                </ul>
            </li>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a  class="nav-link" href="#" id="receivedDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <img src="{{ asset('assets/svg/envelope.svg') }}" style="height:30px;">
                        {# Debut de la gestion de la notification#}
                        {% set i = 0 %}
                        {% for liste in listeCourrier %}
                            {% if liste.recipient.id == user.id %}
                                {% if liste.isRead == 0  %}
                                    {% set i = i + 1 %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {% if i == 0 %}
                            <span class="badge rounded-pill badge-notification bg-danger badge badge-danger badge-counter d-none ">  {{ i }}</span>
                        {% else %}
                            <span class="badge rounded-pill badge-notification bg-danger badge badge-danger badge-counter ">  {{ i }}</span>
                        {% endif %}
                        {# fin #}
                    </a>

                    <div class="dropdown-menu dropdown-menu-right drop" aria-labelledby="receivedDropdown">
                        <h6 class="dropdown-header text-center" >CENTRE COURRIER</h6>
                        {% if app.user.received|length == 0 %}
                            <p class="text-center"> Aucun courrier reçus </p>
                        {% else %}
                            {% for liste in listeCourrier %}
                                {% if liste.recipient.id == user.id %}
                                    {% set bold = "" %}
                                    {% if liste.isRead == 0  %}
                                        {% set bold ="font-weight-bold" %}
                                    {% endif %}
                                    <a href="{{ path("excel", {id: liste.id}) }}" class="d-flex hope {{bold}}" style="height:5.3rem;">
                                        <div class ="jo">
                                            <img class="rounded-circle" src="{{ asset('assets/svg/abstract-user.svg') }}">
                                        </div>
                                        <div style="display:block;">
                                            <div class="text " style="color:black;">
                                                {{ liste.nomC }}
                                            </div>
                                            <div style="color:#b7b9cc;" class="text-truncate">
                                                {{ liste.sender.nom}} , {{ liste.status}}
                                            </div>
                                        </div>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        {% endif %}


                        <a class="dropdown-item text-center" href="{{ path('received') }}">Voir tous les courriers</a>
                    </div>

                    </a>
                </li>
            </ul>

            {# acces de la liste uniquement au utilisateur ayant le role admin #}
            <ul class="navbar-nav">
                <li class="nav-item">
                    {% if is_granted('ROLE_ADMIN') %}
                        <a class="nav-link" href="{{ path('user_index') }}">Liste d'utilisateur</a>
                    {% endif %}
                </li>
            </ul>
            {#fin#}

            <ul class="navbar-nav">
                <div class="dropdown">
                    <li class="nav-item">
                        <img src ="{{asset('assets/svg/4.png')}}" class="img-profile rounded-circle dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                            <span class="dropdown-item"></span>
                            <div class="d-flex">
                                <img src ="{{asset('assets/svg/ip-address.svg')}}" style="height:25px;width:25px;">
                                <h5 style="margin-left:4px;">  {{ user.IP }}</h5>
                            </div>
                            <div  class="d-flex text-center" style="margin-top:5px;">
                                <img src ="{{asset('assets/svg/profile_icon.png')}}" style="height:25px;width:25px;">
                                <h5 style="margin-left:4px;">  {{ user.Nom }}</h5>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="d-flex">
                                <img src ="{{asset('assets/svg/logout.svg')}}">
                                <a class="dropdown-item" style="padding-left:2px;" href="{{ path('app_logout') }}">Déconnexion</a>
                            </div>
                        </div>
                    </li>
                </div>
            </ul>

        </nav>
    </header>
{% endblock %}
{% block body %}
    <h3 class="text-center font-weight-bold"> Pieces</h3>
    <fieldset class="border" style="width:400px; height:auto;" >
        <legend class="w-auto font-weight-bold ">Notes sur ce courrier </legend>
            {{ courrier.notes }}
    </fieldset>

    <table style="margin: 50px;" class="table table-striped table-bordered table_data">
        <thead></thead>
        <tr>
            
            <th>Nom du courrier</th>

            <th>nom</th>
            <th>prenom</th>
            <th>numero</th>
            <th>Valide</th>
           {# <th>Entrée</th> #}
        </tr>
        <tbody>
            {% set nbre_pieces = upload|length %}
            {% set nbre_pieces_check = 0 %}
            {% for piece in upload %}
                <tr>
                 
                    <td>{{ piece.courier.nomC }} </td>

                    <td>{{ piece.nom }}</td>
                    <td> {{ piece.prenom }} </td>
                    <td> {{ piece.numero }} </td>
                    {% set isChecked = piece.valide != 0 ? 'checked' : ''  %}
                    {% set isDisabled = piece.isDisabled != 0 ? 'disabled' : ''  %}
                    <td> <input type="checkbox" {{ isChecked }} class="form-control boxcheck" data-id="{{ piece.id }}" onchange="setValidate({{ piece.id }})" {{ isDisabled }}>

                     {% if piece.valide == 1 %}
                            {% set nbre_pieces_check = nbre_pieces_check + 1 %}
                        {% endif %}
                    </td>
                   {# <td>
                        <input type="text" class="form-control">
                    </td>
                    #}

                </tr>

            {% endfor %}
        </tbody>
    </table>
   } {% set valid = (nbre_pieces == nbre_pieces_check) ? '' : 'd-none'  %}
    <a href="{{path('received')}}" class="btn btn-success {{ valid }}"  id="btn-validate" onclick="confirm()"> validation</a>
   {# <button class="btn btn-primary add" onclick="ajoutLigne()"> Ajouter </button>
    <button class="btn btn-danger del" onclick="delLigne()"> supprimer </button>

   
    <button class="btn btn-dark" onclick="Save()"> Enregistrer</button> #}


    {#-------------------- notes de retour------------------------#}
  
    <fieldset class="border float-right" style="margin:0px;padding:0px;width:500px;height:200px;" >
       <legend  class="w-auto">Notes d'erreur</legend>
       {{ form_start(form) }}
        <div id="notes">
          {{ form_widget(form.notes) }}
        </div>
        <div class="d-none">
          {{ form_label(form.nom_c) }}
          {{ form_widget(form.nom_c) }}
        </div>
        <div class="d-none">
          {{ form_label(form.status) }}
          {{ form_widget(form.status) }}
        </div>
        <div class="d-none">
          {{ form_label(form.recipient) }}
          {{ form_widget(form.recipient) }}
        </div>
        <div class="d-none">
          {{ form_label(form.fichier) }}
          {{ form_widget(form.fichier) }}
      </div>
        {{ form_widget(form.envoyer) }}
        {{ form_end(form) }}
    </fieldset>

    {#-------------------- fin notes de retour------------------------#}

    <script>
       var nbPiece = {{ nbre_pieces }};

        var nbChecked = {{ nbre_pieces_check }};
        //Ajout de ligne
      /*  var ligne="<tr class='ligne'><td><input type='checkbox'  name='select' ></td><td><input type='text' class='form-control courier'  ></td> <td><input type='text' class='form-control nom' name='' ></td> <td><input type='text' name='' class='form-control prenom'></td> <td><input type='text' name='' class='form-control numero'></td> <td><input type='checkbox'  class='form-control boxcheck' name='' ></td>";
        function ajoutLigne()
        {
            $(".table_data > tbody:last").append(ligne);
        }
        function delLigne()
        {
            $(".table_data").find('input[name="select"]').each(function(){
                if($(this).is(":checked"))
                {
                    $(this).parents("table.table_data tr").remove();
                }
            })
        }*/
    //methode pour enregistrer en BD les ajouts et suppressions
    /*    function Save()
        {
            
            var tab_lignes = [];
            $.each($('.ligne') , function (index,value) {
                var el_courier = value.getElementsByClassName('courier')
                var courier = $(el_courier).val();
                var el_nom = value.getElementsByClassName('nom')
                var nom = $(el_nom).val();
                var el_prenom = value.getElementsByClassName('prenom')
                var prenom = $(el_prenom).val();
                var el_numero = value.getElementsByClassName('numero')
                var numero = $(el_numero).val();
                var el_boxcheck = value.getElementsByClassName('boxcheck')
                var boxcheck = $(el_boxcheck).is(":checked");

               var ligne = {
                   'courier' : courier,
                   'nom' : nom,
                   'prenom' : prenom,
                   'numero' : numero,
                   'boxcheck' : boxcheck,
               }
                tab_lignes.push(ligne);

            });

            console.log('tab_lignes')
            console.log(tab_lignes)
            $.ajax({

                method:'POST',
                data:{tab: tab_lignes, id: id},
                success:function(){

                }

            })
        }*/
                // ajax modification de la valeur de la colone validate
            function setValidate(id){
                $.ajax({
                    url : '{{ path('ajax_validate_courier') }}' ,
                    method : 'POST',
                    data : {id : id },// @ToDo recuperer id
                    success : function (data) {
                        if(data){
                            nbChecked++;
                        } else {
                            nbChecked--;
                        }
                        if (nbChecked == nbPiece)
                        {
                            $('#btn-validate').removeClass('d-none')
                        } else
                            {
                                $('#btn-validate').addClass('d-none')
                            }
                    }
                });
            }
        function setDisabled(arrayIds)
        {
            $.ajax({
                url : '{{ path('ajax_disabled_courier') }}' ,
                method : 'POST',
                data : {ids : arrayIds },// @ToDo recuperer id
                success : function (data)
                {
                    //debut reception php->twg
                    //var response = JSON.parse(data);
                   // console.log($response);
                    // fin
                    $('.boxcheck').attr("disabled","disabled");
                    $('.btn-validate').attr("disabled","disabled");

                }
            });
        }
        function confirm()
            {
                var checkboxes = $('.boxcheck');
                var arrayIds = [];
                //parcour avec each
                $.each(checkboxes , function (index,value) {
                    arrayIds.push($(this).data('id'))
                });
                console.log(arrayIds)
                setDisabled(arrayIds);
                //alert(disabled);
            }
    </script>
{% endblock %}
