{% extends 'base.html.twig' %}

{% block title %} Final {% endblock %}
{% block navbar %}

    <header>

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="{{ path('page_index', {id: user.id}) }}"><h2>ACCUEIL</h2></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <li class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        {#<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>#}
                    </li>
                </ul>
            </li>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a  class="nav-link" href="#" id="receivedDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <img src="{{ asset('assets/svg/envelope.svg') }}" style="height:30px;">
                        {# Debut de la gestion de la notification#}
                        {% set i = 0 %}
                        {% for liste in listeCourrier %}
                            {% if liste.recipient.id == user.id %}
                                {% if liste.isRead == 0  %}
                                    {% set i = i + 1 %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {% if i == 0 %}
                            <span class="badge rounded-pill badge-notification bg-danger badge badge-danger badge-counter d-none ">  {{ i }}</span>
                        {% else %}
                            <span class="badge rounded-pill badge-notification bg-danger badge badge-danger badge-counter ">  {{ i }}</span>
                        {% endif %}
                        {# fin #}
                    </a>

                    <div class="dropdown-menu dropdown-menu-right drop" aria-labelledby="receivedDropdown">
                        <h6 class="dropdown-header text-center" >CENTRE COURRIER</h6>
                        {% if app.user.received|length == 0 %}
                            <p class="text-center"> Aucun courrier reçus </p>
                        {% else %}
                            {% for liste in listeCourrier %}
                                {% if liste.recipient.id == user.id %}
                                    {% set bold = "" %}
                                    {% if liste.isRead == 0  %}
                                        {% set bold ="font-weight-bold" %}
                                    {% endif %}
                                    <a href="{{ path("excel", {id: liste.id}) }}" class="d-flex hope {{bold}}" style="height:5.3rem;">
                                        <div class ="jo">
                                            <img class="rounded-circle" src="{{ asset('assets/svg/abstract-user.svg') }}">
                                        </div>
                                        <div style="display:block;">
                                            <div class="text " style="color:black;">
                                                {{ liste.nomC }}
                                            </div>
                                            <div style="color:#b7b9cc;" class="text-truncate">
                                                {{ liste.sender.nom}} , {{ liste.status}}
                                            </div>
                                        </div>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        {% endif %}


                        <a class="dropdown-item text-center" href="{{ path('received') }}">Voir tous les courriers</a>
                    </div>

                    </a>
                </li>
            </ul>

            {# acces de la liste uniquement au utilisateur ayant le role admin #}
            <ul class="navbar-nav">
                <li class="nav-item">
                    {% if is_granted('ROLE_ADMIN') %}
                        <a class="nav-link" href="{{ path('user_index') }}">Liste d'utilisateur</a>
                    {% endif %}
                </li>
            </ul>
            {#fin#}

            <ul class="navbar-nav">
                <div class="dropdown">
                    <li class="nav-item">
                        <img src ="{{asset('assets/svg/4.png')}}" class="img-profile rounded-circle dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                            <span class="dropdown-item"></span>
                            <div class="d-flex">
                                <img src ="{{asset('assets/svg/ip-address.svg')}}" style="height:25px;width:25px;">
                                <h5 style="margin-left:4px;">  {{ user.IP }}</h5>
                            </div>
                            <div  class="d-flex text-center" style="margin-top:5px;">
                                <img src ="{{asset('assets/svg/profile_icon.png')}}" style="height:25px;width:25px;">
                                <h5 style="margin-left:4px;">  {{ user.Nom }}</h5>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="d-flex">
                                <img src ="{{asset('assets/svg/logout.svg')}}">
                                <a class="dropdown-item" style="padding-left:2px;" href="{{ path('app_logout') }}">Déconnexion</a>
                            </div>
                        </div>
                    </li>
                </div>
            </ul>

        </nav>
    </header>
{% endblock %}
{% block body %}
    <h3 class="text-center font-weight-bold"> verification <final></final></h3>
    <fieldset class="border" style="width:400px; height:auto;" >
        <legend class="w-auto font-weight-bold ">infos sur le courrier </legend>
        {{ courrier.notes }}
    </fieldset>

    <table style="margin: 50px;" class="table table-striped table-bordered table_data">
    <thead></thead>
        <tr>

            <th>Nom du courrier</th>
            <th> N° BL </th>
            <th>nom</th>
            <th>prenom</th>
            <th>numero</th>
           {# <th>Valide 1</th> #}
            <th>Valide 2</th>
        </tr>
    <tbody>

    {% for piece in upload %}
        <tr>
            <td>{{ piece.courier.nomC }} </td>
            <td> {{ piece.NBL }}</td>
            <td>{{ piece.nom }}</td>
            <td> {{ piece.prenom }} </td>
            <td> {{ piece.numero }} </td>


            <td class="d-none">
                {# afficher l'ancienne validation avec sa valeur true ou false #}
                {% set checked = piece.valide != 0 ? 'checked' : ''  %}
                <input type="checkbox" {{ checked }} class="form-control v1 "  data-ident="{{ piece.id }}" disabled  >

            </td>
            <td>
                <input type="checkbox" class="form-control v2 " data-id="{{ piece.id }}">
            </td>
        </tr>
    {% endfor %}
    </tbody>
    </table>


    <button  class="btn btn-success" onClick="testValidation()"> Envoyer </button>
    <script>
        //tester si valide 1 = valide 2 sinon mettre une alerte

        function testValidation() {
            //1 ere validation
            var first_tab = [];
            $('.v1').each(function (index, value) {
                //recuperer la valeur du checkbox et l'id de celui-ci,
                var firstCheck = $(this).is(":checked");
                var id_firstval = $(this).data("ident");

                var valSec = {
                    'id': id_firstval,
                    'checkbo': firstCheck,
                }
                first_tab.push(valSec);
            })
            console.log("v1:");
            console.log(first_tab);


            //2 eme validation
            var second_tab = [];
            $('.v2').each(function (index, value) {
                //recuperer la valeur du checkbox et l'id de celui-ci,
                var secCheck = $(this).is(":checked");
                var id_secondVal = $(this).data("id");

                var valSec = {
                    'id': id_secondVal,
                    'checkbo': secCheck,
                }
                second_tab.push(valSec);

            })
            console.log("v2: ");
            console.log(second_tab);

            //comparer les 2 tableaux
            if (first_tab.length != second_tab.length) {
                console.log('erreur de longueur');
            }
            else {

                var reponse = true;
                for (var i = 0; i < first_tab.length; i++) {
                    //console.log(first_tab[i]['id']);
                    if (first_tab[i]['checkbo'] != second_tab[i]['checkbo']) {
                        reponse = false;
                        break;
                    }
                }
            }
            if (reponse) {
                //alert("tout est ok");
                //changer la valeur dans la bd
                $.ajax({
                    url: '{{ path('ajax_validation') }}',
                    method: 'POST',
                    data: {second_tab: second_tab,res: reponse},
                    success: function () {
                        window.location.replace("{{path('send')}}");
                    }
                })
            }
            else
                {
                    console.log("tout n\'est pas ok");
                    alert("le courrier n\' est pas ok")
                }

        }

    </script>
{% endblock %}