{# page du 2 eme verification #}
{% extends 'base.html.twig' %}
{% block title %} Final {% endblock %}
{% block navbar %}
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="{{ path('page_index', {id: user.id}) }}"><h2>ACCUEIL</h2></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <li class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        {#<a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>#}
                    </li>
                </ul>
            </li>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a  class="nav-link" href="#" id="receivedDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <img src="{{ asset('assets/svg/envelope.svg') }}" style="height:30px;">
                        {# Debut de la gestion de la notification#}
                        {% set i = 0 %}
                        {% for liste in listeCourrier %}
                            {% if liste.recipient.id == user.id %}
                                {% if liste.isRead == 0  %}
                                    {% set i = i + 1 %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {% if i == 0 %}
                            <span class="badge rounded-pill badge-notification bg-danger badge badge-danger badge-counter d-none ">  {{ i }}</span>
                        {% else %}
                            <span class="badge rounded-pill badge-notification bg-danger badge badge-danger badge-counter "></span>
                        {% endif %}
                        {# fin #}
                    </a>

                    <div class="dropdown-menu dropdown-menu-right drop" aria-labelledby="receivedDropdown">
                        <h6 class="dropdown-header text-center" >CENTRE COURRIER</h6>
                        {% if app.user.received|length == 0 %}
                            <p class="text-center"> Aucun courrier reçus </p>
                        {% else %}
                            {% for liste in listeCourrier %}
                                {% if liste.recipient.id == user.id %}
                                    {% set bold = "" %}
                                    {% if liste.isRead == 0  %}
                                        {% set bold ="font-weight-bold" %}
                                    {% endif %}
                                    <a href="{{ path("excel", {id: liste.id}) }}" class="d-flex hope {{bold}}" style="height:5.3rem;">
                                        <div class ="jo">
                                            <img class="rounded-circle" src="{{ asset('assets/svg/abstract-user.svg') }}">
                                        </div>
                                        <div style="display:block;">
                                            <div class="text " style="color:black;">
                                                {{ liste.nomC }}
                                            </div>
                                            <div style="color:#b7b9cc;" class="text-truncate">
                                                {{ liste.sender.nom}} , {{ liste.status}}
                                            </div>
                                        </div>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        <a class="dropdown-item text-center" href="{{ path('received') }}">Voir tous les courriers</a>
                    </div>
                    </a>
                </li>
            </ul>
            {# acces de la liste uniquement au utilisateur ayant le role admin #}
            <ul class="navbar-nav">
                <li class="nav-item">
                    {% if is_granted('ROLE_ADMIN') %}
                        <a class="nav-link" href="{{ path('user_index') }}">Liste d'utilisateur</a>
                    {% endif %}
                </li>
            </ul>
            {#fin#}

            <ul class="navbar-nav">
                <div class="dropdown">
                    <li class="nav-item">
                        <img src ="{{asset('assets/svg/4.png')}}" class="img-profile rounded-circle dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                            <span class="dropdown-item"></span>
                            <div class="d-flex">
                                <img src ="{{asset('assets/svg/ip-address.svg')}}" style="height:25px;width:25px;">
                                <h5 style="margin-left:4px;">  {{ user.IP }}</h5>
                            </div>
                            <div  class="d-flex text-center" style="margin-top:5px;">
                                <img src ="{{asset('assets/svg/profile_icon.png')}}" style="height:25px;width:25px;">
                                <h5 style="margin-left:4px;">  {{ user.Nom }}</h5>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="d-flex">
                                <img src ="{{asset('assets/svg/logout.svg')}}">
                                <a class="dropdown-item" style="padding-left:2px;" href="{{ path('app_logout') }}">Déconnexion</a>
                            </div>
                        </div>
                    </li>
                </div>
            </ul>

        </nav>
    </header>
{% endblock %}
{% block body %}
    
   <fieldset class="border" style="width:400px; height:auto; margin-left:30px;" >
              <legend class="w-auto font-weight-bold "><h3> A propos du courrier </h3> </legend>
                        <p> <span class="font-weight-bold"> NOM Courrier : </span> {{ courrier.nomC }}  </p>
                        <p> <span class="font-weight-bold"> Notes : </span> {{ courrier.notes }}  </p>
                        <p> <span class="font-weight-bold"> Status : </span> {{ courrier.status }}  </p>
                        <p> <span class="font-weight-bold"> Destinataire : </span> {{ courrier.recipient.nom }}  </p>
   </fieldset>
    <div class="row text-center" style="margin-top: 30px">
        <div class="col-12 justify-content-center">
            <div class="card card-trap"><div class="card-header">  <h1>Verification</h1></div>
                <div class="card-body">
                    <table class="table table-striped table-bordered" id="data_table2">
                <thead>
                    <tr>
                        <th class="d-none">id</th>
                        <th class="text-center" >N° cmd</th>
                        <th class="text-center" > N° récept </th>
                        <th class="text-center" >N°BL</th>
                        <th class="text-center">Fournisseur</th>
                        <th class="text-center">Rayon</th>
                        <th class="text-center">D.réception</th>
                        <th class="text-center">Montant HT</th>
                        <th class="d-none">Valide 1</th>
                        <th class="text-center">Valide</th>
                    </tr>
                </thead>
                <tbody>
                {% set nbPiece = 0 %}
                    {% for piece in pieces %}
                        <tr>
                            <td class="d-none"> {{ piece.id }}</td>
                            <td>{{ piece.nCMD}} </td>
                            <td>{{ piece.nRecept}} </td>
                            <td> {{ piece.nBL}} </td>
                            <td>{{ piece.fournisseur }}</td>
                            <td> {{ piece.rayon }} </td>
                            <td> {{ piece.DReception }} </td>
                            <td> {{ piece.montantHT }} </td>
                            <td class="d-none">
                                {# afficher l'ancienne validation avec sa valeur true ou false #}
                                {% set checked = piece.valide != 0 ? 'checked' : ''  %}
                                <input type="checkbox" {{ checked }} class="form-control v1 "  data-ident="{{ piece.id }}" disabled  >
                            </td>
                            <td>
                                <input type="checkbox" class="form-control v2 " data-id="{{ piece.id }}">
                            </td>
                        </tr>
                        {% set nbPiece = nbPiece + 1 %}
                    {% endfor %}
                <p> Total des pieces : {{ nbPiece }}</p>
                </tbody>
            </table>
                </div>
                <button  class="btn btn-success w-5" onClick="testValidation()"> Envoyer </button>
            </div>
        </div>
    </div>


    <script>
     $('#data_table2').DataTable({
            "language": {
                "lengthMenu": "Afficher _MENU_ données par pages",
                "zeroRecords": "Nous n'avons rien trouvé - désolé",
                "info": " page _PAGE_ sur _PAGES_",
                "infoEmpty": "Aucun enregistrement disponibles",
                "infoFiltered": "(Filtrer à partir de _MAX_ enregistrement)",
                "search": "Rechercher:",
                "paginate": {
                    "first": "Premier",
                    "last": "Dernier",
                    "next": "Suivant",
                    "previous": "Précedent"
                },
            },
        });
        //tester si valide 1 = valide 2 sinon mettre une alerte
        function testValidation() {
            //1 ere validation
            var first_tab = [];
            $('.v1').each(function (index, value) {
                //recuperer la valeur du checkbox et l'id de celui-ci,
                var firstCheck = $(this).is(":checked");
                var id_firstval = $(this).data("ident");
                var valSec = {
                    'id': id_firstval,
                    'checkbo': firstCheck,
                }
                first_tab.push(valSec);
            })
            console.log("v1:");
            console.log(first_tab);
            //2 eme validation
            var second_tab = [];
            $('.v2').each(function (index, value) {
                //recuperer la valeur du checkbox et l'id de celui-ci,
                var secCheck = $(this).is(":checked");
                var id_secondVal = $(this).data("id");
                var valSec = {
                    'id': id_secondVal,
                    'checkbo': secCheck,
                }
                second_tab.push(valSec);
            })
            console.log("v2: ");
            console.log(second_tab);
            //comparer les 2 tableaux
            if (first_tab.length != second_tab.length) {
                console.log('erreur de longueur');
            }
            else{
                var reponse = true;
                for (var i = 0; i < first_tab.length; i++) {
                    //console.log(first_tab[i]['id']);
                    if (first_tab[i]['checkbo'] != second_tab[i]['checkbo']) {
                        reponse = false;
                        break;
                    }
                }
            }
            if (reponse) {
                //alert("tout est ok");
                //changer la valeur dans la bd
                $.ajax({
                    url: '{{ path('ajax_validation') }}',
                    method: 'POST',
                    data: {second_tab: second_tab,res: reponse},
                    success: function () {
                        bootbox.alert('le courrier à été envoyé avec succès');
                        window.location.replace("{{path('send')}}");
                    },
                    beforeSend: function(){
                                    bootbox.dialog({ 
                                    message: '<div class="text-center"><i class="fa fa-spin fa-spinner"></i> veuillez patientez...</div>', 
                                    closeButton: false })}
                })
            }
            else
                {
                    console.log("tout n\'est pas ok");
                     bootbox.alert('les validations ne sont pas correctes');
                }
        }
    </script>
{% endblock %}